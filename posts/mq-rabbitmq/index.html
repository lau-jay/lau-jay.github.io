<!doctype html><html lang=zh-CN><head><title>MQ-RabbitMQ - 世界的过客</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="The HTML5 Herald"><meta name=author content="Jay Lau"><meta property="og:title" content="MQ-RabbitMQ"><meta property="og:description" content="从一个简单的例子开始。
首先是生产者
import sys import pika credentials = pika."><meta property="og:type" content="article"><meta property="og:url" content="https://laujay.com/posts/mq-rabbitmq/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-05-27T09:04:57+08:00"><meta property="article:modified_time" content="2020-05-27T09:04:57+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="MQ-RabbitMQ"><meta name=twitter:description content="从一个简单的例子开始。
首先是生产者
import sys import pika credentials = pika."><meta name=generator content="Hugo 0.121.1"><link rel="shortcut icon" href=https://laujay.com/img/favicon.ico><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin=anonymous><link rel=stylesheet href=https://laujay.com/fontawesome/css/all.min.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto+Slab|Ruda"><link rel=stylesheet type=text/css href=https://laujay.com/css/styles.css></head><body><div id=container><header><h1><a href=https://laujay.com/>世界的过客</a></h1><ul id=social-media><li><a href=https://github.com/lau-jay title=GitHub><i class="fab fa-github fa-lg"></i></a></li></ul><p><em>每个人获得的东西都恰好是他值得获得的东西</em></p></header><nav><ul><li><a href=https://laujay.com/about><i class="fa-li fa fa-lg"></i><span>About</span></a></li><li><a href=https://laujay.com/categories><i class="fa-li fa fa-lg"></i><span>Categories</span></a></li><li><a href=https://laujay.com/tags><i class="fa-li fa fa-lg"></i><span>Tags</span></a></li></ul></nav><main><article><h1>MQ-RabbitMQ</h1><aside><ul><li><time class=post-date datetime=2020-05-27T09:04:57+08:00>May 27, 2020</time></li><li>One minute read</li></ul></aside><div class=featured_image><a href=https://laujay.com/posts/mq-rabbitmq/ title=MQ-RabbitMQ><img src></a></div><p>从一个简单的例子开始。</p><p>首先是生产者</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> sys
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> pika
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>credentials <span style=color:#f92672>=</span> pika<span style=color:#f92672>.</span>PlainCredentials(<span style=color:#e6db74>&#34;guest&#34;</span>, <span style=color:#e6db74>&#34;guest&#34;</span>)
</span></span><span style=display:flex><span>conn_params <span style=color:#f92672>=</span> pika<span style=color:#f92672>.</span>ConnectionsParameters(<span style=color:#e6db74>&#34;localhost&#34;</span>,  
</span></span><span style=display:flex><span>    credentials<span style=color:#f92672>=</span> credentials)
</span></span><span style=display:flex><span>conn_broker <span style=color:#f92672>=</span> pika<span style=color:#f92672>.</span>BlockingConnection(conn_params) <span style=color:#75715e># 到此为止,建立了到代理服务器的链接</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>channel <span style=color:#f92672>=</span> conn_broker<span style=color:#f92672>.</span>channel() <span style=color:#75715e># 获取信道</span>
</span></span><span style=display:flex><span>channel<span style=color:#f92672>.</span>exchange_declare(exchange<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;hello-exchange&#34;</span>, 
</span></span><span style=display:flex><span>         type<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;direct&#34;</span>, passive<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>, durable<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, 
</span></span><span style=display:flex><span>         auto_delete<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>) <span style=color:#75715e># 声明交换器</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>msg <span style=color:#f92672>=</span> sys<span style=color:#f92672>.</span>argv[<span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>msg_props <span style=color:#f92672>=</span> pika<span style=color:#f92672>.</span>BasicProperties()
</span></span><span style=display:flex><span>msg_props<span style=color:#f92672>.</span>content_type<span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>“</span>text<span style=color:#f92672>/</span>plain<span style=color:#e6db74>&#34;. # 创建纯文本消息</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>channel<span style=color:#f92672>.</span>basic_publish(body<span style=color:#f92672>=</span>msg, exchange<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;hello-exchange&#34;</span>, 
</span></span><span style=display:flex><span>                     properties<span style=color:#f92672>=</span>msg_props,
</span></span><span style=display:flex><span>                     routing_key<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;hola&#34;</span>) <span style=color:#75715e># 发布消息</span>
</span></span><span style=display:flex><span>conn_broker<span style=color:#f92672>.</span>close()
</span></span></code></pre></div><p>消费者:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> sys
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> pika
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>credentials <span style=color:#f92672>=</span> pika<span style=color:#f92672>.</span>PlainCredentials(<span style=color:#e6db74>&#34;guest&#34;</span>, <span style=color:#e6db74>&#34;guest&#34;</span>)
</span></span><span style=display:flex><span>conn_params <span style=color:#f92672>=</span> pika<span style=color:#f92672>.</span>ConnectionsParameters(<span style=color:#e6db74>&#34;localhost&#34;</span>,
</span></span><span style=display:flex><span>                   credentials<span style=color:#f92672>=</span> credentials)
</span></span><span style=display:flex><span>conn_broker <span style=color:#f92672>=</span> pika<span style=color:#f92672>.</span>BlockingConnection(conn_params) <span style=color:#75715e># 到此为止,建立了到代理服务器的链接</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>channel <span style=color:#f92672>=</span> conn_broker<span style=color:#f92672>.</span>channel() <span style=color:#75715e># 获取信道</span>
</span></span><span style=display:flex><span>channel<span style=color:#f92672>.</span>exchange_declare(exchange<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;hello-exchange&#34;</span>, 
</span></span><span style=display:flex><span>               type<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;direct&#34;</span>, passive<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>, durable<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, 
</span></span><span style=display:flex><span>               auto_delete<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>) <span style=color:#75715e># 声明交换器</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>channel<span style=color:#f92672>.</span>queue_declare(queue<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;hello-queue&#34;</span>) <span style=color:#75715e># 声明队列</span>
</span></span><span style=display:flex><span>channel<span style=color:#f92672>.</span>queue_bind(queue<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;hello-queue&#34;</span>, exchange<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;hello-exchange&#34;</span>,
</span></span><span style=display:flex><span>               routing_key<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;hola&#34;</span>) <span style=color:#75715e># 通过routing_key将队列和交换器绑定起来</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>msg_consumer</span>(channel, method, header, body):
</span></span><span style=display:flex><span>    channel<span style=color:#f92672>.</span>basic_ack(delivery_tag<span style=color:#f92672>=</span>method<span style=color:#f92672>.</span>delivery_tag)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> body<span style=color:#f92672>.</span>decode(<span style=color:#e6db74>&#34;utf8&#34;</span>) <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;quit&#34;</span>: <span style=color:#75715e># 例子来源于rabbitmq实战,但是body在 python3中是byte类型</span>
</span></span><span style=display:flex><span>        channel<span style=color:#f92672>.</span>basic_cancel(consumer_tag<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;hello-consumer&#34;</span>)
</span></span><span style=display:flex><span>        channel<span style=color:#f92672>.</span>stop_consuming()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>        print(body<span style=color:#f92672>.</span>decode(<span style=color:#e6db74>&#34;utf8&#34;</span>))
</span></span><span style=display:flex><span>channel<span style=color:#f92672>.</span>basic_consume(queue<span style=color:#f92672>=</span>queue_name, 
</span></span><span style=display:flex><span>        on_message_callback<span style=color:#f92672>=</span> msg_consumer, auto_ack<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>)
</span></span><span style=display:flex><span>channel<span style=color:#f92672>.</span>start_consuming()
</span></span></code></pre></div><h2 id=生产者和消费者>生产者和消费者</h2><p>生产者创建消息=》发布到代理服务器(RabbitMQ)</p><h3 id=消息>消息</h3><p>消息分为: payload和label</p><p>payload是你要传输的内容,label描述了有效载荷.</p><p>AMQP用标签表述消息, rabbitmq根据标签把消息发送给感兴趣的接受放. 其方式是fire-and-forget</p><p>接受者得到payload, 标签在过程中不会发送</p><h3 id=持久化消息>持久化消息</h3><p>delivery mode 设置为2, 但是必须是持久化的交换器和持久化的队列, 三者加在一起才能真正具有持久化.</p><h3 id=信道channel>信道(channel)</h3><p>信道事建立在“真实” TCP链接内的虚拟链接, 信道复用TCP链接,可以有无数个信道,但是会共用一个TCP链接.</p><h2 id=amqp三要素>AMQP三要素</h2><h3 id=交换器exchange>交换器(exchange)</h3><p>生产者把消息发布到交换器上</p><p>交换器根据routing-key来决定消息投递到哪个队列</p><p>队列通过routing-key绑定到交换器.</p><p>交换器类型: topic, fanout, direct, headers</p><p>direct: 如果路由键匹配,就投递到对应的队列</p><p>fanout: 广播到所有绑定到该交换器的队列上</p><p>topic: 多个来源的消息到同一个队列上</p><h3 id=持久化>持久化</h3><p>durable设置为True</p><h3 id=队列queue>队列(queue)</h3><p>消息到达队列,并被消费者接受</p><h3 id=创建队列>创建队列</h3><p>queue.declare, 如果消费者在一条信道上订阅了某个队列,无法再声明队列了, 必须先取消订阅, 将 信道设置为“传输模式”.</p><p>queue.declare有两个参数:</p><ul><li><p>exclusive, 为true, 队列私有, 只能创建的使用,一个队列一个消费者</p></li><li><p>auto-delete , 最后一个消费者取消订阅后, 队列自动移除.</p></li></ul><p>交换器是topic情况下:queue.bind_queue通过指定队列名, 交换器名, 和绑定键名, 将队列绑定到交换器.</p><h3 id=持久化-1>持久化</h3><p>durable设置为True</p><h3 id=绑定bind_key>绑定(bind_key)</h3><p>绑定key决定了交换器将符合绑定key规则的消息都发送到这个队列里.</p><h2 id=vhost虚拟主机>vhost虚拟主机</h2><p>虚拟主机实现了自身的交换器,队列,和绑定, 并且带有权限控制</p><p>vhost只能通过命令行来创建删除</p><h3 id=创建>创建</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># rabbitmqctl add_vhost[vhost_name]</span>
</span></span></code></pre></div><h3 id=删除>删除</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># rabbitmqctl delete_vhost[vhost_name]</span>
</span></span></code></pre></div><h3 id=显示>显示</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># rabbitmqctl list_vhosts</span>
</span></span></code></pre></div><h2 id=多个消费者订阅到同一队列如何分发消息>多个消费者订阅到同一队列,如何分发消息</h2><p>rabbitmq拥有多个消费者的时候, 队列收到的消息将以(round-robin)的方式发送给消费者, 每个消息只会发送给一个消费者.</p><h2 id=ack机制>ACK机制</h2><p>消费者确认消息会basic.ack显式发送确认.或者auto-ack为true. 如果没有ack,链接断开,那么该消息会被发给下一个 消费者, 确保消息被正确处理.</p><p>如果没有返回ack,那么rabbitmq不会发送下一条消息给消费者.</p><h2 id=reject机制>Reject机制</h2><p>如果消费者容易出问题,但是消息又不想删除, 两种做法,第一断开链接,第二 basic.reject(版本大于2.0).</p><p>如果reject设置了requeue参数为true, 该消息会被发给下一个消费者.</p></article><section class=post-nav><ul><li><a href=https://laujay.com/posts/the-python-packaging/><i class="fa fa-chevron-circle-left"></i> The Python Packaging</a></li><li><a href=https://laujay.com/posts/docker-network-external/>Docker Network External <i class="fa fa-chevron-circle-right"></i></a></li></ul></section><section class=comments-block><button id=show-comments style=display:none><i class="fa fa-comments"></i> Add/View Comments</button></section><section id=disqus_thread></section><script>(function(){if(window.location.hostname=="localhost")return;var t,n=!1,o="lau-jay",s=document.getElementById("show-comments"),i=!0,a=null;if(a)return;s.style.display="",i?e():s.addEventListener("click",e,!1);function e(){if(!n){n=!0;var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+o+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e),document.getElementById("show-comments").style.display="none"}}t=window.location.hash.substr(1),t.length>8&&t.substring(0,8)=="comment-"&&e(),/bot|google|baidu|bing|msn|duckduckgo|slurp|yandex/i.test(navigator.userAgent)&&e()})()</script></main><footer><h6>Copyright © 2016 ~ 2023 - Jay Lau|Theme by <a href=https://github.com/funkydan2/hugo-kiera>kiera</a> |
Rendered by <a href=https://gohugo.io title=Hugo>Hugo</a> |
<a href=https://laujay.com/index.xml>Subscribe</a></h6></footer></div><script src=https://laujay.com/js/scripts.js></script><script>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-91611718-2","auto"),ga("send","pageview"))</script></body></html>