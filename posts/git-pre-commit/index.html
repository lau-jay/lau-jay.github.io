<!doctype html><html lang=zh-CN><head><title>git pre-commit workflow - 世界的过客</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="The HTML5 Herald"><meta name=author content="Jay Lau"><meta property="og:title" content="git pre-commit workflow"><meta property="og:description" content="之前看了程序人生的一篇code is law，做了点小小的实践。想起在QQ群看到一个人的分享截图，于是就想将之前做的实践查到的资料删减翻译下整理成文章，如果万一有团队内部的技术分享会还是可以分享下的。"><meta property="og:type" content="article"><meta property="og:url" content="https://laujay.com/posts/git-pre-commit/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-03-06T20:14:29+08:00"><meta property="article:modified_time" content="2019-03-06T20:14:29+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="git pre-commit workflow"><meta name=twitter:description content="之前看了程序人生的一篇code is law，做了点小小的实践。想起在QQ群看到一个人的分享截图，于是就想将之前做的实践查到的资料删减翻译下整理成文章，如果万一有团队内部的技术分享会还是可以分享下的。"><meta name=generator content="Hugo 0.121.1"><link rel="shortcut icon" href=https://laujay.com/img/favicon.ico><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin=anonymous><link rel=stylesheet href=https://laujay.com/fontawesome/css/all.min.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto+Slab|Ruda"><link rel=stylesheet type=text/css href=https://laujay.com/css/styles.css></head><body><div id=container><header><h1><a href=https://laujay.com/>世界的过客</a></h1><ul id=social-media><li><a href=https://github.com/lau-jay title=GitHub><i class="fab fa-github fa-lg"></i></a></li></ul><p><em>每个人获得的东西都恰好是他值得获得的东西</em></p></header><nav><ul><li><a href=https://laujay.com/about><i class="fa-li fa fa-lg"></i><span>About</span></a></li><li><a href=https://laujay.com/categories><i class="fa-li fa fa-lg"></i><span>Categories</span></a></li><li><a href=https://laujay.com/tags><i class="fa-li fa fa-lg"></i><span>Tags</span></a></li></ul></nav><main><article><h1>git pre-commit workflow</h1><aside><ul><li><time class=post-date datetime=2019-03-06T20:14:29+08:00>Mar 6, 2019</time></li><li>Categories:
<em><a href=https://laujay.com/categories/tool>tool</a></em></li><li><em><a href=https://laujay.com/tags/git>#git</a>
,
<a href=https://laujay.com/tags/translation>#translation</a></em></li><li>One minute read</li></ul></aside><div class=featured_image><a href=https://laujay.com/posts/git-pre-commit/ title="git pre-commit workflow"><img src></a></div><blockquote><p>之前看了程序人生的一篇code is law，做了点小小的实践。想起在QQ群看到一个人的分享截图，于是就想将之前做的实践查到的资料删减翻译下整理成文章，如果万一有团队内部的技术分享会还是可以分享下的。</p></blockquote><p>我想遵循pep8，我不想手动格式化代码，我不想每次手动执行flake8来检查，甚至我不想手动执行mypy去检查我代码。</p><p>那么有什么办法呢，作为开发，日常最常执行的操作git commit必然是其中之一，无论是通过IDE的GUI工具还是命令行的方式。</p><p>通过git提供的pre-commit的hook可以在commit的时候将代码格式化，规范检查，测试等执行完毕，而不需要工程师手动做相关的操作。流程类似这样的：</p><p><img src=https://ljvmiranda921.github.io/assets/png/tuts/precommit_pipeline.png alt=workflow></p><p>通过采用<em>pre-commit</em> 这个Python编写的库只需要以下几步就可以完成上述任务。</p><ul><li><code>pipenv install -dev pre-commit</code></li><li>编辑.pre-commit-config.yaml</li><li>执行pre-commit install 以便在.git/目录中安装git hooks</li></ul><p>比如你想用black格式化代码，flak8检查代码规范，单元测试那么例子如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>repos</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>repo</span>: <span style=color:#ae81ff>local</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>hooks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>id</span>: <span style=color:#ae81ff>black</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>black</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>language</span>: <span style=color:#ae81ff>system</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>entry</span>: <span style=color:#ae81ff>black</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>types</span>: [<span style=color:#ae81ff>python]</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>id</span>: <span style=color:#ae81ff>flake8</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>flake8</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>language</span>: <span style=color:#ae81ff>system</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>entry</span>: <span style=color:#ae81ff>flake8</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>types</span>: [<span style=color:#ae81ff>python]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>id</span>: <span style=color:#ae81ff>unitest</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>unitest</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>language</span>: <span style=color:#ae81ff>system</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>entry</span>: <span style=color:#ae81ff>./test.sh</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>types</span>: [<span style=color:#ae81ff>python]</span>
</span></span></code></pre></div><p>repos是顶层的，每个hook都可以增加一个repo的section。
repo存储库映射告诉pre-commit从哪里获取提现实现好的hook比如这里的flake8可以改为远程的https://github.com/pre-commit/pre-commit-hooks
在上面这个例子中，由于我都在本地装了entry对应的文件，所以直接使用local
entry 表示可执行的文件或者命令
types 表示对哪些文件的更改起作用
language 表示hook是哪些语言实现的，这里直接偷懒用系统,让他自己找</p><p>有时候我们自己的标注和pep8的略有不同，那么可以在当前目录下增加 <code>.flake8</code> 来告诉flake8我们自己的客制化。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[<span style=color:#a6e22e>flake8</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>ignore</span> = <span style=color:#a6e22e>E203</span>, <span style=color:#a6e22e>E266</span>, <span style=color:#a6e22e>E501</span>, <span style=color:#a6e22e>W503</span>, <span style=color:#a6e22e>F403</span>, <span style=color:#a6e22e>F401</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>max-line-length</span> = <span style=color:#ae81ff>79</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>max-complexity</span> = <span style=color:#ae81ff>18</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>select</span> = <span style=color:#a6e22e>B</span>,<span style=color:#a6e22e>C</span>,<span style=color:#a6e22e>E</span>,<span style=color:#a6e22e>F</span>,<span style=color:#a6e22e>W</span>,<span style=color:#a6e22e>T4</span>,<span style=color:#a6e22e>B9</span>
</span></span></code></pre></div><ul><li>本文章原文及本文的图片来自<a href=https://ljvmiranda921.github.io/notebook/2018/06/21/precommits-using-black-and-flake8/>这里</a> 版权归原作者所有</li></ul></article><section class=post-nav><ul><li><a href=https://laujay.com/posts/env-is-evil/><i class="fa fa-chevron-circle-left"></i> Env is Evil: ycmd server SHUT DOWN Unexpected exit code -11</a></li><li><a href=https://laujay.com/posts/re-basic/>Python中的正则基础 <i class="fa fa-chevron-circle-right"></i></a></li></ul></section><section class=comments-block><button id=show-comments style=display:none><i class="fa fa-comments"></i> Add/View Comments</button></section><section id=disqus_thread></section><script>(function(){if(window.location.hostname=="localhost")return;var t,n=!1,o="lau-jay",s=document.getElementById("show-comments"),i=!0,a=null;if(a)return;s.style.display="",i?e():s.addEventListener("click",e,!1);function e(){if(!n){n=!0;var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+o+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e),document.getElementById("show-comments").style.display="none"}}t=window.location.hash.substr(1),t.length>8&&t.substring(0,8)=="comment-"&&e(),/bot|google|baidu|bing|msn|duckduckgo|slurp|yandex/i.test(navigator.userAgent)&&e()})()</script></main><footer><h6>Copyright © 2016 ~ 2023 - Jay Lau|Theme by <a href=https://github.com/funkydan2/hugo-kiera>kiera</a> |
Rendered by <a href=https://gohugo.io title=Hugo>Hugo</a> |
<a href=https://laujay.com/index.xml>Subscribe</a></h6></footer></div><script src=https://laujay.com/js/scripts.js></script><script>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-91611718-2","auto"),ga("send","pageview"))</script></body></html>