<!doctype html><html lang=zh-CN><head><title>Django Timezone - 世界的过客</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="The HTML5 Herald"><meta name=author content="Jay Lau"><meta property="og:title" content="Django Timezone"><meta property="og:description" content="引言 线上遇到了个问题， 微信广告的订单回传，时间错了，然后去修这个时间错误。结果发现Django shell里执行datetime."><meta property="og:type" content="article"><meta property="og:url" content="https://laujay.com/posts/django-timezone/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-08-28T19:54:29+08:00"><meta property="article:modified_time" content="2021-08-28T19:54:29+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Django Timezone"><meta name=twitter:description content="引言 线上遇到了个问题， 微信广告的订单回传，时间错了，然后去修这个时间错误。结果发现Django shell里执行datetime."><meta name=generator content="Hugo 0.121.1"><link rel="shortcut icon" href=https://laujay.com/img/favicon.ico><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin=anonymous><link rel=stylesheet href=https://laujay.com/fontawesome/css/all.min.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto+Slab|Ruda"><link rel=stylesheet type=text/css href=https://laujay.com/css/styles.css></head><body><div id=container><header><h1><a href=https://laujay.com/>世界的过客</a></h1><ul id=social-media><li><a href=https://github.com/lau-jay title=GitHub><i class="fab fa-github fa-lg"></i></a></li></ul><p><em>每个人获得的东西都恰好是他值得获得的东西</em></p></header><nav><ul><li><a href=https://laujay.com/about><i class="fa-li fa fa-lg"></i><span>About</span></a></li><li><a href=https://laujay.com/categories><i class="fa-li fa fa-lg"></i><span>Categories</span></a></li><li><a href=https://laujay.com/tags><i class="fa-li fa fa-lg"></i><span>Tags</span></a></li></ul></nav><main><article><h1>Django Timezone</h1><aside><ul><li><time class=post-date datetime=2021-08-28T19:54:29+08:00>Aug 28, 2021</time></li><li>Categories:
<em><a href=https://laujay.com/categories/python>Python</a></em></li><li><em><a href=https://laujay.com/tags/timezone>#timezone</a>
,
<a href=https://laujay.com/tags/django>#django</a></em></li><li>One minute read</li></ul></aside><div class=featured_image><a href=https://laujay.com/posts/django-timezone/ title="Django Timezone"><img src></a></div><h2 id=引言>引言</h2><p>线上遇到了个问题， 微信广告的订单回传，时间错了，然后去修这个时间错误。结果发现Django shell里执行datetime.utcnow的结果和now的结果以及time.time的结果居然是一模一样的。然后一路查找，先确认服务器的时间没问题，百思不解，意外在服务器上直接拉起原生的repl发现执行结果又正常了，然后去看代码发现Django的设置里时区被设置为utc了。那么上述所有的问题都得到解答了。所以下面记录下复习Django时区的过程, 如有不对欢迎指正。</p><h2 id=utc和gmt8>UTC和GMT+8</h2><p>GMT：<strong>G</strong>reenwich <strong>M</strong>ean <strong>T</strong>ime 格林尼治标准时间。这是以英国格林尼治天文台观测结果得出的时间，这是英国格林尼治当地时间，这个地方的当地时间过去被当成世界标准的时间。</p><p>UT：<strong>U</strong>niversal <strong>T</strong>ime 世界时。根据原子钟计算出来的时间。</p><p>UTC：<strong>C</strong>oordinated <strong>U</strong>niversal <strong>T</strong>ime 协调世界时。因为地球自转越来越慢，每年都会比前一年多出零点几秒，每隔几年协调世界时组织都会给世界时+1秒，让基于原子钟的世界时和基于天文学（人类感知）的格林尼治标准时间相差不至于太大。并将得到的时间称为UTC，这是现在使用的世界标准时间。</p><p>协调世界时不与任何地区位置相关，也不代表此刻某地的时间，所以在说明某地时间时要加上时区</p><p>也就是说GMT并不等于UTC，而是等于UTC+0，只是格林尼治刚好在0时区上。</p><p>GMT = UTC+0</p><h3 id=naive-datetime-object-vs-aware-datetime-object><strong>naive datetime object</strong> vs <strong>aware datetime object</strong></h3><p>当使用datetime.now()得到一个datetime对象的时候，此时该datetime对象没有任何关于时区的信息，即datetime对象的tzinfo属性为None(tzinfo属性被用于存储datetime object关于时区的信息)，该datetime对象就被称为<strong>naive datetime object</strong>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> datetime<span style=color:#f92672>.</span>now()<span style=color:#f92672>.</span>tzinfo
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span>
</span></span></code></pre></div><p>既然naive datetime object没有关于时区的信息存储，相对的aware datetime object就是指存储了时区信息的datetime object。在使用now函数的时候，可以指定时区，但该时区参数必须是datetime.tzinfo的子类</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#f92672>from</span> django.utils.timezone <span style=color:#f92672>import</span> utc, is_aware
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#f92672>import</span> datetime
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> datetime<span style=color:#f92672>.</span>datetime<span style=color:#f92672>.</span>now()
</span></span><span style=display:flex><span>datetime<span style=color:#f92672>.</span>datetime(<span style=color:#ae81ff>2021</span>, <span style=color:#ae81ff>8</span>, <span style=color:#ae81ff>28</span>, <span style=color:#ae81ff>20</span>, <span style=color:#ae81ff>30</span>, <span style=color:#ae81ff>7</span>, <span style=color:#ae81ff>922670</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> datetime<span style=color:#f92672>.</span>datetime<span style=color:#f92672>.</span>utcnow()
</span></span><span style=display:flex><span>datetime<span style=color:#f92672>.</span>datetime(<span style=color:#ae81ff>2021</span>, <span style=color:#ae81ff>8</span>, <span style=color:#ae81ff>28</span>, <span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>30</span>, <span style=color:#ae81ff>13</span>, <span style=color:#ae81ff>591417</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> aware <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>datetime<span style=color:#f92672>.</span>now(utc)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> aware
</span></span><span style=display:flex><span>datetime<span style=color:#f92672>.</span>datetime(<span style=color:#ae81ff>2021</span>, <span style=color:#ae81ff>8</span>, <span style=color:#ae81ff>28</span>, <span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>30</span>, <span style=color:#ae81ff>46</span>, <span style=color:#ae81ff>966581</span>, tzinfo<span style=color:#f92672>=&lt;</span>UTC<span style=color:#f92672>&gt;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> is_aware(aware)
</span></span><span style=display:flex><span><span style=color:#66d9ef>True</span>
</span></span></code></pre></div><p>在Django中提供了几个简单的函数如is_aware, is_naive, make_aware和make_naive用于辨别和转换naive datetime object和aware datetime object。</p></article><section class=post-nav><ul><li><a href=https://laujay.com/posts/why-three-way-handshake/><i class="fa fa-chevron-circle-left"></i> Why Three Way Handshake</a></li><li><a href=https://laujay.com/posts/2021/>2021 <i class="fa fa-chevron-circle-right"></i></a></li></ul></section><section class=comments-block><button id=show-comments style=display:none><i class="fa fa-comments"></i> Add/View Comments</button></section><section id=disqus_thread></section><script>(function(){if(window.location.hostname=="localhost")return;var t,n=!1,o="lau-jay",s=document.getElementById("show-comments"),i=!0,a=null;if(a)return;s.style.display="",i?e():s.addEventListener("click",e,!1);function e(){if(!n){n=!0;var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+o+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e),document.getElementById("show-comments").style.display="none"}}t=window.location.hash.substr(1),t.length>8&&t.substring(0,8)=="comment-"&&e(),/bot|google|baidu|bing|msn|duckduckgo|slurp|yandex/i.test(navigator.userAgent)&&e()})()</script></main><footer><h6>Copyright © 2016 ~ 2023 - Jay Lau|Theme by <a href=https://github.com/funkydan2/hugo-kiera>kiera</a> |
Rendered by <a href=https://gohugo.io title=Hugo>Hugo</a> |
<a href=https://laujay.com/index.xml>Subscribe</a></h6></footer></div><script src=https://laujay.com/js/scripts.js></script><script>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-91611718-2","auto"),ga("send","pageview"))</script></body></html>