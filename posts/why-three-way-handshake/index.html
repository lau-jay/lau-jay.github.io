<!doctype html><html lang=zh-CN><head><title>Why Three Way Handshake - 世界的过客</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="The HTML5 Herald"><meta name=author content="Jay Lau"><meta property="og:title" content="Why Three Way Handshake"><meta property="og:description" content="为什么TCP握手要3次 从两个面试题谈起
ping 目标主机100ms, 不考虑网络联通问题，理想情况(不考虑丢包）下http多少ms，https多少ms(不考虑非对称加密解密耗时) TCP三次握手为啥是3次，为什么不是2或者4次，TCP握手到底在干嘛？ 第一个是朋友谈起的一个面试题，第二个是我问候选人的面试题。"><meta property="og:type" content="article"><meta property="og:url" content="https://laujay.com/posts/why-three-way-handshake/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-07-17T00:49:58+08:00"><meta property="article:modified_time" content="2021-07-17T00:49:58+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Why Three Way Handshake"><meta name=twitter:description content="为什么TCP握手要3次 从两个面试题谈起
ping 目标主机100ms, 不考虑网络联通问题，理想情况(不考虑丢包）下http多少ms，https多少ms(不考虑非对称加密解密耗时) TCP三次握手为啥是3次，为什么不是2或者4次，TCP握手到底在干嘛？ 第一个是朋友谈起的一个面试题，第二个是我问候选人的面试题。"><meta name=generator content="Hugo 0.121.1"><link rel="shortcut icon" href=https://laujay.com/img/favicon.ico><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin=anonymous><link rel=stylesheet href=https://laujay.com/fontawesome/css/all.min.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto+Slab|Ruda"><link rel=stylesheet type=text/css href=https://laujay.com/css/styles.css></head><body><div id=container><header><h1><a href=https://laujay.com/>世界的过客</a></h1><ul id=social-media><li><a href=https://github.com/lau-jay title=GitHub><i class="fab fa-github fa-lg"></i></a></li></ul><p><em>每个人获得的东西都恰好是他值得获得的东西</em></p></header><nav><ul><li><a href=https://laujay.com/about><i class="fa-li fa fa-lg"></i><span>About</span></a></li><li><a href=https://laujay.com/categories><i class="fa-li fa fa-lg"></i><span>Categories</span></a></li><li><a href=https://laujay.com/tags><i class="fa-li fa fa-lg"></i><span>Tags</span></a></li></ul></nav><main><article><h1>Why Three Way Handshake</h1><aside><ul><li><time class=post-date datetime=2021-07-17T00:49:58+08:00>Jul 17, 2021</time></li><li>2 minute read</li></ul></aside><h1 id=为什么tcp握手要3次>为什么TCP握手要3次</h1><p>从两个面试题谈起</p><ul><li>ping 目标主机100ms, 不考虑网络联通问题，理想情况(不考虑丢包）下http多少ms，https多少ms(不考虑非对称加密解密耗时)</li><li>TCP三次握手为啥是3次，为什么不是2或者4次，TCP握手到底在干嘛？</li></ul><p>第一个是朋友谈起的一个面试题，第二个是我问候选人的面试题。</p><p>先来说第二个问题，候选人给了我意料中的回复：</p><blockquote><p>打个比方比如打电话：</p><ol><li>你听得到吗？</li><li>我能听到，你听得到？</li><li>我也能听到</li></ol><p>所以需要三次</p></blockquote><p>这回答让人感概颇深, 国内互联网充斥着以讹传讹的博文，却没多少人想着去翻翻RFC。
就连教材往往都是语焉不详。</p><h3 id=连接是什么>连接是什么</h3><p>所以为什么建立连接需要三次？所以TCP握手究竟干了什么？连接是什么？：</p><blockquote><p>The reliability and flow control mechanisms described above require that TCPs initialize and maintain certain status information for each data stream. The combination of this information, including sockets, sequence numbers, and window sizes, is called a connection.</p></blockquote><p><a href=https://datatracker.ietf.org/doc/html/rfc793>rfc793</a> 明确定义了连接，这里看最后一句The combination of this information, including sockets, sequence numbers, is called a connection。也就是说连接是一种包括sockets, 序号, 窗口大小这些信息的机制。</p><p>连接清楚了，那么接下来探究为什么建立连接需要三次，握手期间是怎么做到初始化信息，注意这里不会讨论其他，主要讨论为啥是三次。</p><h3 id=为什么需要三次>为什么需要三次</h3><h4 id=旧的重复连接与序号的获取>旧的重复连接与序号的获取</h4><blockquote><p>The principle reason for the three-way handshake is to prevent old duplicate connection initiations from causing confusion.</p></blockquote><p>同样来自<a href=https://datatracker.ietf.org/doc/html/rfc793>rfc793</a> ，为了阻止历史的重复连接初始化 。这里不妨发挥下脑补能力。现实生活并不美好，真实的网络是不可靠的，大家都知道互联网传输的可靠性在传输层来保证，他是怎么保证的呢。先来看握手图：</p><p><img src=https://laujay.com/img/why-three/handshake-rfc.png alt=three-handshake></p><p>其实关于第一个面试题中的http的耗时，从这个图里就可以得到结论了。（100/2）* （3 + 2)）=250ms，传输层3次握手加一次应用层协议确立。https以此类推即可。</p><p>然后发挥想象：</p><p>A发起一个连接，但是过了很久都没收到B的响应（超时了，丢包了等），A不知道是什么原因，于是重发，重发再重发直到放弃。</p><p>B收到了A的SEQ是100的请求，只是A不知道还在继续发，B收到了后就知道有关A想搞事儿，如果B不想理就丢弃了，A最终会放弃这个没问题。但是如果B想逗一下A于是就理会了，发了个应答包给A。</p><p>当然B也不确定A收到没，而且这里还有可能SEQ是99的包绕路比100还慢, 所以这里得分情况讨论：</p><ul><li><p>SEQ 100先到了，那这个时候再回应就就是重复了，接受方B不知道哪个更早哪个更迟，所以B的响应会将SEQ+1写到ACK字段里也就是ACK=101给A， 同理B得带上自己的序号SEQ=300 。</p></li><li><p>SEQ 99到了。接受方B不知道哪个更早哪个更迟，所以B的响应会将SEQ+1写到ACK字段里也就是ACK=100给A， 同理B得带上自己的序号SEQ=301。</p></li></ul><p>B发送的应答（ACK=101）的可能会发送很多次，但是只要一次到了A，A就认为B同意建立连接搞事儿了，因为对A来说，有去有回。这时候A会给B发送应答应答的应答，B在等这个，应答，也就是A-》B， SEQ=101，ACK=301的应答。</p><p>B发送的应答（ACK=100）的可能会发送很多次，但是只要一次到了A，A就发现我要的ack是101， 那么直接发CTL =RST SEQ=100中止了B的SEQ=99的那次连接。</p><p><strong>所以需要第三次来保证旧的连接会被发送方关了，且通信双方都有来有回双方都能互通。</strong></p><p>到此，我们即握手了三次，又能阻止网络丢包导致的旧握手请求问题，还同步了双方各自发的包的序号，关于序号的获取rfc有如下描述 ：</p><blockquote><p>A three way handshake is necessary because sequence numbers are not tied to a global clock in the network, and TCPs may have different mechanisms for picking the ISN’s. The receiver of the first SYN has no way of knowing whether the segment was an old delayed one or not, unless it remembers the last sequence number used on the connection (which is not always possible), and so it must ask the sender to verify this SYN. The three way handshake and the advantages of a clock-driven scheme are discussed in [3].</p></blockquote><p>那么还剩下最后一个问题，<strong>次数</strong>。</p><h4 id=次数>次数</h4><p>上面简单说了3次能保证双方都是有来有回，但是其实只是取了TCP Header优化后的，本质上其实更多次按照这逻辑来做也是行的，比如B对A的响应ACK和SEQ完全可以分两次发，只是头部的设计能让通信更优化一点，B的ACK和SEQ可以一次发送。所以使用最少次数即：<strong>3次</strong>。</p><p><img src=https://laujay.com/img/why-three/tcp-header-format.png alt=tcp-header-format></p><p>这里第二个面试题也回答了。</p></article><section class=post-nav><ul><li><a href=https://laujay.com/posts/mysql-full-table-scan/><i class="fa fa-chevron-circle-left"></i> Mysql 全表扫描</a></li><li><a href=https://laujay.com/posts/django-timezone/>Django Timezone <i class="fa fa-chevron-circle-right"></i></a></li></ul></section><section class=comments-block><button id=show-comments style=display:none><i class="fa fa-comments"></i> Add/View Comments</button></section><section id=disqus_thread></section><script>(function(){if(window.location.hostname=="localhost")return;var t,n=!1,o="lau-jay",s=document.getElementById("show-comments"),i=!0,a=null;if(a)return;s.style.display="",i?e():s.addEventListener("click",e,!1);function e(){if(!n){n=!0;var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+o+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e),document.getElementById("show-comments").style.display="none"}}t=window.location.hash.substr(1),t.length>8&&t.substring(0,8)=="comment-"&&e(),/bot|google|baidu|bing|msn|duckduckgo|slurp|yandex/i.test(navigator.userAgent)&&e()})()</script></main><footer><h6>Copyright © 2016 ~ 2023 - Jay Lau|Theme by <a href=https://github.com/funkydan2/hugo-kiera>kiera</a> |
Rendered by <a href=https://gohugo.io title=Hugo>Hugo</a> |
<a href=https://laujay.com/index.xml>Subscribe</a></h6></footer></div><script src=https://laujay.com/js/scripts.js></script><script>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-91611718-2","auto"),ga("send","pageview"))</script></body></html>