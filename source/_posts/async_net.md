---
title: 网络编程文章阅读笔记
date: 2017-12-17 1:38:29
categories: note
tags: reading
---
[auxten网络编程阅读笔记](https://zhuanlan.zhihu.com/p/32059005)
# 历史
* 一次处理一个连接
* 每个连接开个进程
* 引入线程减少开进程的开销
* 空间焕时间，进程/线程池
* 非阻塞事件驱动
## 阻塞
```
CHECK_INTERVAL = 5 * 60 # 检测间隔
mailbox_fd = listen(MAILBOX) # 假设邮箱对应着一个端口
while True:
    mails = CheckMailBox(mailbox_fd) # 看一眼mail
    if mails: # 说明有信来了！！
        # 处理邮件
        processMail()
    sleep(CHECK_INTERVAL)
```
## 长连接&连接池
TCP连接”仅仅是连接的两端对于四元组和sequence号的一种约定
在性能比较敏感的程序中，为了节省TCP网络调用建立连接三次握手的时间，
很多程序都会选择采用复用之前已经建立过的连接的方法来优化。
再加上往往是“请求、响应、请求、响应”的模式，单个连接限制了QPS（Query Per Second）的提升。 
所以会采取开启多个连接组成一个“池子”的方式来优化性能，我们称之为连接池。

为了规避上面说的对图片等静态资源的影响，大多数商业网站会启用独立的静态资源域名。
从而保证主站的动态资源请求和静态资源的请求不会互相挤占连接。
### 名词解释
* 四元组： 源IP地址、目的IP地址、源端口、目的端口
* 五元组： 源IP地址、目的IP地址、协议、源端口、目的端口
* 七元组： 源IP地址、目的IP地址、协议、源端口、目的端口，服务类型，接口索引

### 端口
端口被设计出来主要是为了给协议栈和应用对应：
    协议栈用端口号将数据分配给不同的应用层程序
    应用层程序用端口号去区分不同的连接，参见上文

端口被分为三类：著名端口、监听端口和动态端口。
* 著名端口是由因特网赋号管理局（IANA）来分配的，并且通常被用于系统进程。
    系统的/etc/services也有相应端口和服务名的对应，主要是用来给netstat、nmap 等系统命令做端口名反解用。
    著名的应用程序作为服务器程序来运行，并侦听经常使用这些端口的连接。 这些端口的一个显著特征就是限定在0~1023，并且在Linux、UNIX平台均需要 Root权限才能监听这些端口。
    常见的`著名端口`有：FTP:21、SSH:22、SMTP:25、HTTP:80、HTTPS:443等。
* 监听端口通常被用来运行各种用户自己写的服务，服务监听在这些端口下不需要特别的权限。
    * BSD使用的监听端口范围是1024到4999。
    * IANA建议49152至65535作为“监听端口”。
    * 许多Linux内核使用32768至61000范围。 配置文件 /proc/sys/net/ipv4/ip_local_port_range 有当前系统设定。

* 动态端口通常被用来在主动发起连接时随机分配使用，在任何特定的TCP连接外不具有任何意义。
这是由于TCP等协议是通过四元组来区分不同的网络连接。 当本机主动发起TCP连接的时候如果目的IP、目的端口、本地IP都是一样的，
只能通过占用不同的本地端口来区分不同的连接。
   0~65535除去上述著名端口、监听端口两种端口号，剩下的端口都是备用的动态端口。 所以在某些特殊用途的需要主动发起大量连接的服务器上（例如：爬虫、代理）， 需要调整 /proc/sys/net/ipv4/ip_local_port_range 的数值，来保留更多的 动态端口以供使用。


## 事件通知机制
select, poll O(n) 的效率select还有上限1024
epoll是Linux内核的可扩展I/O事件通知机制。
它设计目的只在取代既有POSIX select(2)与poll(2)系统函数，
让需要大量操作文件描述符的程序得以发挥更优异的性能
(举例来说：旧有的系统函数所花费的时间复杂度为O(n)，epoll则耗时O(1))
```
关于epoll的ET和LT之前已经说过，这里借用Alice和Bob的例子。

    ET (Edge Triggered) 边沿触发

        来了信件，指示板上的灯只闪一下。

    LT (Level Triggered) 水平触发

        来了信件，指示板上的灯一直亮着，直到信箱中的信全部被取走。
```
